name: 'mwg-check'

on:
  pull_request:
          #types: [opened, reopened, edited, synchronize]
    paths:
      - '!**/**'
      - 'ansible/**'
        #  pull_request_review:
        #    types: [dismissed]

permissions:
  contents: read
  pull-requests: write

jobs:
  check:
    runs-on: [ self-hosted, Linux ]
    outputs:
      run_job: ${{ steps.check_files.outputs.run_job }}
    steps:
    - uses: actions/checkout@v3
    - name: check modified files
      id: check_files
      run: |
        echo "=============== list modified files ==============="
        git diff --name-only HEAD^ HEAD
  
        echo "========== check paths of modified files =========="
        git diff --name-only HEAD^ HEAD &gt; test.txt
        while IFS= read -r file
        do
          echo $file
          if [[ $file != ansible/keys/* ]]; then
            echo "This modified file is not under the 'keys' folder."
            echo "::set-output name=run_job::false"
            break
          else
            echo "::set-output name=run_job::true"
          fi
        done &lt; test.txt

  mwg-check:
    needs: check
    runs-on: [ self-hosted, Linux ]
    if: ${{ (!github.event.pull_request.merged ) && (!github.event.pull_request.draft) && (needs.check.outputs.run_job == 'true') }}
    defaults:
      run:
        working-directory: ./ansible
    steps:
    - uses: actions/checkout@v3
    - uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}
    - id: 'mwg-check'
      run: |
        ansible-playbook -i inventory.yaml hello-world.yaml -C
